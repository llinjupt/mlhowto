.. role:: raw-latex(raw)
    :format: latex html

概率与贝叶斯分类
=====================

从概率开始
--------------

基本数学概念
~~~~~~~~~~~~~~

随机试验的特征：

- 可在相同条件下重复进行，之所以强调相同条件，是因为改变了试验条件，试验就被改变了，试验 A 就变成了试验 B，所以说某项试验就暗含了是在某种条件约束下进行的。
- 在试验结果出来之前，可事先明确所有可能的结果（Outcomes）。例如抛硬币只有正反两面。
- 试验结果出来之前是不能确定结果的。

概率讨论基于随机试验的结果，某种试验被简写为试验 E (Experiment，也可使用 Trial)，试验 E 的所有可能结果组成的集合（Set，结果的全集），被称为试验 E 的样本空间，简写为 S（sample space，或希腊字母  :raw-latex:`\(\Omega\)` 表示），显然 S 就是结果集，例如抛硬币试验的样本空间 S:{正，反}。S 集合中的每个元素称为样本空间 S 的样本点（Sample），例如“正”样本点。

试验 E 的样本空间 S 的子集被称为试验 E 的随机事件（Random Event），简称事件（Event），显然事件的本质是集合，而集合是在一定条件下的结果集，例如抛硬币中的 “正” 事件。根据事件包含样本点的数目，可以分为：

- 基本事件，也被称为原子事件，有单个样本点组成的集合称为基本事件，S 有多少个样本点，就有多少个基本事件。例如抛硬币试验 E 的基本事件为 {正} 和 {反}。基本事件两两互不相容，互为互斥事件，如何事件（除不可能事件）都可以表示为多个基本事件的并集。
- 必然事件，S 是自身的子集，本质就是由所有基本事件构成的集合。
- 不可能事件，空集不包含任何基本事件，每次试验都不可能发生。

根据事件之间的关系，两个或多个事件可以分为以下几种关系：

- 独立事件：A, B 事件无相互影响，相互独立，P(A) = P(A|B)，同时 P(B) = P(B|A) 也成立。
- 互斥事件：A, B 事件不可能同时发生；1 个发生，另一个就不可能发生。
- 对立事件，也被称为互逆事件：如果 A,B 为对立事件，那么要么 A 发生，要么 B 发生，P(A) + P(B) = 1，A 的对立事件常记作 A'。

事件之间的关系常用韦恩图（venn diagram）表示，它可以方便地描述 2 个事件的关系。

对 S 集合进行完备划分，使得所有事件互斥，且并集为 S，那么就得到一个完备事件组(complete events group)，简称为完备组，例如掷骰子（a die，复数为 dice）试验，样本空间为 S:{1,2,3,4,5,6}，An 表示划分的事件，它的完备组可以为：

- A1 和 A2，其中 A1: {1,2,3}，A2: {4, 5, 6}
- A1,A2...A6，其中 A1:{1}，A2{2}，A3{3} 以此类推。

显然如果事件 A1、A2、A3...An 构成一个完备组，则它们两两互不相容，其并集为样本空间。完备组被用于定义全概率公式，A 和 A' 是一组典型的完备组。

考虑掷骰子试验 E：它的样本空间为 S:{1,2,3,4,5,6}。基于该样本空间集合，我们可以考察很多条件下的事件：

- 奇偶条件：取到偶数的事件，取到奇数的事件。
- 大小条件：取到 <= 3 的事件，>=5 的事件。
- 倍数条件：取到是 3 的倍数的事件，非 3 的倍数的事件。
- 取到数字同时为偶数且是 3 的倍数的事件。

显然考察条件不同，事件就不同。概率表征事件 A 发生可能性的大小，那么如何精确定义某个事件的概率呢？随机试验的结果具有随机现象：每次试验结果呈现不确定性，在大量重复试验中结果又具有统计规律性。

- 频数：在相同条件下，进行 n 次试验，事件 A 发生的次数 :raw-latex:`\(n_A\)` 称为事件 A 发生的频数。
- 频率：  :raw-latex:`\(n_A\)`/:raw-latex:`\(n\)`  称为事件 A 发生的频率，并记为 :raw-latex:`\(f_n(A)\)` 。
- 概率：当 :raw-latex:`\(n\to \infty\)` 时，:raw-latex:`\(f_n(A)\)` 被定义为事件 A 发生的概率，记为 P(A)，P 是 Probability 的缩写。

有些时候，我们更关心试验结果的某些函数，而不是结果本身，例如在掷两枚骰子的试验中，关心点数之和为 7 的情况。

随机变量：定义在样本空间上的实值单值函数，简写为 X，也即 X=X(e)，e 表示样本空间 S 中的样本点。随机变量与随机事件一样，具有统计规律性，使用它来描述各种随机现象。

此时使用一种随机变量的定义就可以定义一个事件，例如事件 {X=7} 表示两次掷骰子的和为 7 的事件，且概率表示为 P(X=7)。

韦恩图
~~~~~~~~~~~~~

韦恩图（venn diagram）在集合理论中被广泛使用，由于概率的本质就是事件集合相对于样本空间的占比，所以韦恩图也被用于描述事件之间的关系和运算。

.. figure:: imgs/bayes/venn.png
  :scale: 50%
  :align: center
  :alt: venn

  韦恩图表示事件的关系和运算（图自网络）

继续考虑掷骰子试验，我们可以对应上图描述以下事件之间的关系：

- 图1：描述事件的包含关系，例如事件 A {X<5}，事件 B {X<3}，显然 A 是 B 的子集
- 图2：描述互斥事件，不可同时发生，例如事件 A{X>4}，B {X<3}。
- 图3：描述相关事件的并集，例如事件 A {X = 偶数}，B {X > 3}，则阴影部分对应 A {X = 偶数 或 X > 3}。
- 图4：描述相关事件的交集，例如事件 A {X = 偶数}，B {X > 3}，则阴影部分对应 A {X = 偶数 且 X > 3}。
- 图5 和 图6 描述事件补集的关系。
- 图8 描述了对立事件（互逆事件），例如 A{X < 3}，B{X >= 3}，它们构成了一个完备组。

通过韦恩图可以非常直观得计算出 2 个事件的交并，互补事件的概率。但是它不适合描述多事件和多随机变量事件，否则图像将变得混乱，同时它也不适合描述条件概率。

.. figure:: imgs/bayes/venn1.jpg
  :scale: 80%
  :align: center
  :alt: venn

  韦恩图描述多事件关系

打地鼠与概率规则
~~~~~~~~~~~~~~~~~~~~

考虑掷骰子试验，结果为偶数的概率是多少？结果为偶数时，它是 3 的倍数的概率有多少？如果结果为 3 的倍数，它是偶数的概率有多少？这就涉及到了先验概率，条件概率和联合概率的关系和计算问题。

- 先验概率（prior probability）：可以通过分析得到，不依赖于其他事件，例如P(X=偶数) = 3/6 = 1/2。
- 条件概率（conditional probability），记作 P(A|B)，在事件 B 发生后，A 发生的概率，例如 P(Y=3的倍数|X=偶数)。
- 联合概率（joint probability），记作 P(A,B) 或 P(A :raw-latex:`\(\cap\)` B)，A 和 B事件同时发生的概率，例如 P(Y=3的倍数，X=偶数)。

这三种概率之间是什么关系呢？为了推导概率的一般规则，考虑下面的打地鼠游戏：

.. figure:: imgs/bayes/hit.jpg
  :scale: 80%
  :align: center
  :alt: venn

  打地鼠游戏

地鼠从某个洞中探出头来，游戏者非常快速地把它敲回去，这非常有趣。如果我们想要统计一些规律：从某行出来，某列出来，某个洞中出来。为了分析地鼠探头的规律性，可以抽象成以下模型：

地鼠出现的位置可以使用两个随机变量来描述：X 和 Y，X 表示横坐标，Y 表示纵坐标，假设 X 的取值为 :raw-latex:`\(x_i\)`, 其中 i = 1,2,3...I；Y 可以取值为  :raw-latex:`\(y_j\)`，其中 y = 1,2,3...J，考虑 N 次试验，同时对随机变量 X 和 Y 进行统计：

- 把 {X = :raw-latex:`\(x_i\)` 且 Y = :raw-latex:`\(y_j\)`} 的出现次数记作 :raw-latex:`\(n_{ij}\)` ;
- 把 X 取值为 :raw-latex:`\(x_i\)` （与 Y 无关，只关心列，column）的出现次数记为 :raw-latex:`\(c_i\)` ;
- 把 Y 取值为 :raw-latex:`\(y_j\)` （与 X 无关，只关心行，row）的出现次数记为 :raw-latex:`\(r_j\)` 。

.. figure:: imgs/bayes/grid.png
  :scale: 100%
  :align: center
  :alt: grid

  两个随机变量的网格图表示

根据概率定义，当 N 趋向于无穷时，可以得出联合概率计算公式：

.. math::

  P(X=x_i,Y=y_j) = \frac{n_{ij}}{N} \qquad  (1)

同理，先验概率 X = :raw-latex:`\(x_i\)` 的计算公式为出现在 i 列上的次数 :raw-latex:`\(c_i\)` 与总试验的次数比值：

.. math::

  P(X=x_i) = \frac{c_{i}}{N} \qquad  (2)

另外注意到  :raw-latex:`\(c_i = \sum_j{n_{ij}}\)`，可以得出概率的加和规则（sum rule）：

.. math::

  P(X=x_i) = \sum_jP(X=x_i,Y=y_i) \qquad (3)

已知落在列 i 上的总点数 :raw-latex:`\(c_i\)` ，那么落在 ij 上的点数  :raw-latex:`\(n_{ij}\)` 与它的比值就是条件概率：

.. math::

  P(Y=y_j|X=x_i) = \frac{n_{ij}}{c_i} \qquad (4)

根据公式 (1)(2)(4)，可以得出联合概率和条件概率的关系，它被称为概率的乘法规则（product rule）：

.. math::

  P(X=x_i,Y=y_j) = \frac{n_{ij}}{N} = \frac{n_{ij}}{c_i}\frac{c_i}{N} = P(Y=y_j|X=x_i)P(X=x_i) \qquad (5)

同样根据乘法规则，可以得到 :raw-latex:`\(P(Y=y_j,X=x_i)\)` 的概率公式：

.. math::

  P(Y=y_j,X=x_i) = \frac{n_{ij}}{N} = \frac{n_{ij}}{r_j}\frac{r_j}{N} = P(X=x_i|Y=y_j)P(Y=y_j) \qquad (6)

通过公式 (5)(6) 可以看出联合概率在两个条件概率之间架起了一座桥梁，得到条件概率的算术关系：

.. math::
  
  \ P(y_j|x_i)=\frac{P(x_i|y_j)P(y_j)}{P(x_i)} \qquad (Bayes' theorem)

上式被称为贝叶斯定理（Bayes' theorem），它是机器学习中朴素贝叶斯和贝叶斯分类算法的理论基础。上式中的分母可以用全概率公式表示：

.. math::

  P(X) = \sum_j{P(X|y_j)}{P(y_j)}

其中的所有的 :raw-latex:`\(y_j\)` 事件构成了一个完备组。

条件概率与概率树
~~~~~~~~~~~~~~~~~

上面使用网格图表示两个随机变量，可以清晰地阐述三种概率的关系。但是当随机变量超过 2 个时，使用网格图就无法表达了。概率树可以清晰地表示多种随机变量关系。

.. figure:: imgs/bayes/tree.png
  :scale: 70%
  :align: center
  :alt: tree

  概率树

概率树以分层的方式依次描述不同的随机变量。

- 第一层随机变量描述随机变量 X，它有 i 个分支，分别对应 :raw-latex:`\(X=x_i)\)` 事件，这里简写为事件 A 和 A'，先验概率在相应的分支上标出，对应的节点标出事件 A 和 A'，所有分支上的事件构成一个完备组，它们的概率和为 1。
- 第二层分支线上标出已知所连接的上一级结果的情况下的第二层结果的概率。所以它是条件概率。
- 根据乘法规则，从根节点沿着分支依次向右连乘，得到联合概率。

概率树使用规则：

- 努力分出需要计算的概率的不同层级。如果给定了条件概率 P(A|B)，则第一层应该考虑 B 的各分支，第二层再考虑 A。
- 将已知概率填入概率树相应位置。
- 每一层各个分支构成一个完备组，概率总和为 1，我们可以根据 P(A) 计算出它的对立事件 P(A') =  1 - P(A)。
- 根据乘法规则，由已知概率求解联合概率，或者条件概率。

有了概率树，我们在应用贝叶斯定理时将非常直观和清晰，这里以一个示例说明。

某种疾病在人群中的感染概率为 1%，某种试剂对感染情况进行阳性测试，如果该人已感染，则阳性概率为 95%（另外 5% 被称为假阴性），如果未感染，则阳性概率为 10%（称为假阳性）。如果某人试验为阳性，那么他感染该疾病的概率为多少？

表面上看，由于测试为阳性，感染的几率可能很高，实际可能并非如此。根据概率树使用规则，首先分析问题中的随机变量包含两种：

- 是否感染（Infect），我们使用 P(Y) 和 P(N) 表示它们的概率
- 是否检出阳性（Positive，阴性为 Negative），我们使用 P(+) 和 P(-) 表示它们的概率。

由于我们已知人群的感染率，所以感染情况的概率放在第一层，得到：

.. code-block:: sh
  :linenos:
  :lineno-start: 0
    
      Y
    / 
   / P(Y) = 1/100
  /
  \
   \ P(N) = 1 - P(Y) = 99/100
    \
      N 

接着分别在已经感染人群和非感染人群中考虑阳性检出情况：

.. code-block:: sh
  :linenos:
  :lineno-start: 0

            + P(+,Y) = P(+|Y)P(Y) = 1%*95%
           /
          / P(+|Y) = 95%     
         Y
        / \ P(-|Y) = 1 - P(+|Y) = 5%
       /   \
      /     -
     /
    / P(Y) = 1%
   /
   \ 
    \ P(N) = 1 - P(Y) = 99%
     \
      \     + P(+,N) = P(+|Y)P(Y) = 10%*99%
       \   /
        \ / P(+|N) = 10% 
         N 
          \ P(-|N) = 1 - P(+|N) = 90%
           \
            -

如果某人试验为阳性，那么他感染该疾病的概率为多少？首先求出所有试验为阳性的人数占比：P(+,Y) + P(+,N) = P(+|Y)P(Y) + 
P(+|N)P(N) = 1%*95% + 10%*99%，其中真阳性的人数占比为 P(+,Y)，所以求出在检出阳性后患病概率为：

.. math::
  
  \ P(Y|+)=\frac{P(+,Y)}{P(+,Y) + P(+,N)} = \frac{P(+,Y)}{P(+|Y)P(Y) + P(+|N)P(N)}

结果为 95/(95+990) = 8.76%，所以即便检出为阳性，由于感染人群的概率很小，此人患病的可能性依然很低。

观察上面的计算公式，可以看出就是对贝叶斯定理的应用：

.. math::

  \begin{eqnarray}
  \ P(+,Y) &=& P(+|Y)P{Y} \qquad (乘法规则) \\  
  \ P(+) &=& P(+|Y)P(Y) + P(+|N)P(N) \qquad (全概率公式)
  \end{eqnarray}

以上两式代入上式中的分子和分母就是贝叶斯公式：

.. math::

  P(Y|+) = \frac{P(+|Y)P(Y)}{P(+)}

显然通过概率树由已知条件概率计算相反的条件概率，要比直接套用贝叶斯公式更清晰直观，且非常简便。
